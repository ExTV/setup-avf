#!/bin/bash
# ============================================================
#  AVF VM Setup & Optimization Script â€” Pixel Devices
#  Enhanced for gfxstream / virtio-gpu / Android Virt Framework
# ============================================================

set -euo pipefail

# â”€â”€ Colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
BLUE='\033[0;34m'; CYAN='\033[0;36m'; BOLD='\033[1m'; NC='\033[0m'

# â”€â”€ Log file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_LOGNAME="avf_setup_$(date +%Y%m%d_%H%M%S).log"
if touch "/var/log/$_LOGNAME" 2>/dev/null; then
    LOG="/var/log/$_LOGNAME"
else
    LOG="$HOME/$_LOGNAME"
fi
exec > >(tee -a "$LOG") 2>&1
echo -e "${CYAN}ðŸ“„ Logging to $LOG${NC}"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info()    { echo -e "${BLUE}â„¹  $*${NC}"; }
success() { echo -e "${GREEN}âœ… $*${NC}"; }
warn()    { echo -e "${YELLOW}âš   $*${NC}"; }
die()     { echo -e "${RED}âŒ $*${NC}" >&2; exit 1; }
step()    { echo -e "\n${BOLD}${BLUE}â”â”â” $* â”â”â”${NC}"; }
ask()     { local _ans; printf "${CYAN}â“ $1 [y/N]: ${NC}" >/dev/tty; read -r _ans </dev/tty; [[ "$_ans" =~ ^[Yy]$ ]]; }

# â”€â”€ Trap: show last failed command â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
trap 'die "Script failed at line $LINENO â€” check $LOG for details."' ERR

# â”€â”€ Require root-capable sudo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sudo -v || die "sudo access required."
# Keep sudo alive throughout the script
( while true; do sudo -v; sleep 50; done ) &
SUDO_PID=$!
trap 'kill $SUDO_PID 2>/dev/null; exit' EXIT

# â”€â”€ AVF / Pixel detection (soft-warn, not hard-fail) â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\n${BOLD}${CYAN}ðŸš€ AVF VM Setup â€” Pixel Edition${NC}"
if grep -qi "android\|crosvm\|virtio" /proc/cpuinfo 2>/dev/null ||
   [ -e /dev/virtio-ports/com.android.microdroid.testservice ] ||
   [ -e /sys/bus/virtio ]; then
    success "AVF / virtio environment detected."
else
    warn "Could not confirm AVF environment â€” continuing anyway."
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[1/7] DNS Configuration"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo chattr -i /etc/resolv.conf 2>/dev/null || true
sudo tee /etc/resolv.conf > /dev/null <<'EOF'
# AVF VM â€” locked DNS
nameserver 8.8.8.8
nameserver 1.1.1.1
options timeout:2 attempts:3
EOF
sudo chattr +i /etc/resolv.conf
success "DNS â†’ Google (8.8.8.8) / Cloudflare (1.1.1.1) â€” locked."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[2/7] User Persistence (Linger)"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo loginctl enable-linger "$USER"
success "Linger enabled for $USER."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[3/7] System Update"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export DEBIAN_FRONTEND=noninteractive
sudo apt-get update -qq
sudo apt-get full-upgrade -y -o Dpkg::Options::="--force-confdef" \
                            -o Dpkg::Options::="--force-confold"
sudo apt-get autoremove -y --purge
sudo apt-get clean
success "System fully updated."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[4/7] Remove Legacy Weston / Display Shims"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo apt-get remove --purge -y weston 2>/dev/null || true

legacy_files=(
    "/home/droid/weston.env"
    "/usr/local/bin/enable_display"
    "/usr/local/bin/enable_gfxstream"
    "/etc/profile.d/activate_display.sh"
    "/etc/profile.d/weston.sh"
)
for f in "${legacy_files[@]}"; do
    [ -f "$f" ] && { sudo rm -v "$f"; info "Removed: $f"; }
done
success "Legacy graphics shims removed."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[5/7] SSH Setup"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ask "Enable SSH on port 9922?"; then
    sudo apt-get install -y openssh-server

    SSHD=/etc/ssh/sshd_config
    sudo cp "$SSHD" "${SSHD}.bak"

    sudo sed -i \
        -e 's/^#\?Port .*/Port 9922/' \
        -e 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' \
        -e 's/^#\?X11Forwarding .*/X11Forwarding yes/' \
        -e 's/^#\?AllowTcpForwarding .*/AllowTcpForwarding yes/' \
        "$SSHD"

    sudo sshd -t || die "sshd config test failed â€” check $SSHD."
    sudo systemctl enable --now ssh
    success "SSH running on port 9922. Backup â†’ ${SSHD}.bak"
else
    info "SSH skipped."
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[6/7] GPU & gfxstream Environment Variables"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Detect gfxstream ICD â€” fall back gracefully
GFXSTREAM_ICD="/usr/share/vulkan/icd.d/gfxstream_vk_icd.json"
VENUS_ICD="/usr/share/vulkan/icd.d/virtio_icd.x86_64.json"

if [ -f "$GFXSTREAM_ICD" ]; then
    VK_ICD="$GFXSTREAM_ICD"
    info "Using gfxstream ICD."
elif [ -f "$VENUS_ICD" ]; then
    VK_ICD="$VENUS_ICD"
    warn "gfxstream ICD not found â€” falling back to Venus (virtio-gpu)."
else
    VK_ICD="$GFXSTREAM_ICD"   # write path anyway; may appear post-reboot
    warn "No Vulkan ICD found yet â€” writing expected gfxstream path."
fi

sudo cp /etc/environment /etc/environment.bak 2>/dev/null || true
sudo tee /etc/environment > /dev/null <<EOF
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games"

# â”€â”€ AVF / gfxstream GPU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MESA_LOADER_DRIVER_OVERRIDE=zink
VK_ICD_FILENAMES=${VK_ICD}

# Zink / Kopper workarounds for AVF compositors
MESA_VK_WSI_DEBUG=sw,linear
XWAYLAND_NO_GLAMOR=1
LIBGL_KOPPER_DRI2=1
LIBGL_ALWAYS_SOFTWARE=0

# Wayland socket (common AVF path)
WAYLAND_DISPLAY=wayland-0
XDG_RUNTIME_DIR=/run/user/$(id -u)

# EGL platform for Xwayland under virtio-gpu
__EGL_VENDOR_LIBRARY_FILENAMES=/usr/share/glvnd/egl_vendor.d/50_mesa.json
EOF

success "GPU overrides written to /etc/environment (backup â†’ /etc/environment.bak)."

# â”€â”€ Also export immediately for rest of session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set -a; source /etc/environment; set +a

# â”€â”€ Auto-detect Mesa/Vulkan packages needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MESA_PKGS=()
dpkg -l mesa-vulkan-drivers &>/dev/null || MESA_PKGS+=(mesa-vulkan-drivers)
dpkg -l libvulkan1         &>/dev/null || MESA_PKGS+=(libvulkan1)
dpkg -l vulkan-tools       &>/dev/null || MESA_PKGS+=(vulkan-tools)

if [ ${#MESA_PKGS[@]} -gt 0 ]; then
    info "Installing missing Vulkan/Mesa packages: ${MESA_PKGS[*]}"
    sudo apt-get install -y "${MESA_PKGS[@]}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "[7/7] Optional Packages"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo -e "  ${CYAN}a)${NC} Podman + Distrobox + Fastfetch"
echo -e "  ${CYAN}b)${NC} Desktop Environment (XFCE4 â€” lightweight, AVF-friendly)"
echo -e "  ${CYAN}c)${NC} Wayland compositor (Sway â€” virtio-gpu accelerated)"
echo -e "  ${CYAN}d)${NC} Dev tools (git, curl, wget, htop, neovim, tmux, jq)"
echo ""

if ask "Install optional packages? (select per prompt)"; then
    ask "a) Podman + Distrobox + Fastfetch?" && \
        sudo apt-get install -y podman distrobox fastfetch

    ask "b) XFCE4 desktop?" && \
        sudo apt-get install -y xfce4 xfce4-terminal xfce4-goodies \
                                dbus-x11 xorg xinit

    ask "c) Sway Wayland compositor?" && \
        sudo apt-get install -y sway swaylock swaybar \
                                foot xwayland

    ask "d) Dev / CLI tools?" && \
        sudo apt-get install -y git curl wget htop neovim tmux jq \
                                build-essential python3-pip unzip
else
    info "Optional packages skipped."
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "\n${BOLD}${GREEN}âœ¨ Setup complete!${NC}"
echo -e "   Log saved â†’ ${CYAN}$LOG${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo -e "  1. ${CYAN}sudo reboot${NC}"
echo -e "  2. After reboot, verify GPU: ${CYAN}vulkaninfo 2>/dev/null | grep 'GPU id'${NC}"
echo -e "  3. If using XFCE: ${CYAN}startxfce4${NC}"
echo -e "  4. If using Sway: ${CYAN}sway${NC} (requires WAYLAND_DISPLAY set)"
echo -e "  5. SSH (if enabled): ${CYAN}ssh -p 9922 $USER@<pixel-ip>${NC}"
echo ""
